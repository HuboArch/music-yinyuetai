<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>music</title>
    <link rel="stylesheet" href="css/index.css">
    <script src="js/cssTransform.js"></script>
    <script>
        setRem();
        function setRem() {
            var html = document.querySelector('html');
            var width = html.getBoundingClientRect().width;

            html.style.fontSize = width / 16 + 'px';
        }
        // 横竖屏切换
        window.addEventListener('resize', setRem, false);
    </script>
</head>
<body>
<section class="wrap">
    <header id="header">
        <div class="headerC">
            <h1 id="logo"><a href="javascript:;"><img src="img/logo.png" alt=""></a></h1>
            <a href="javascript:void(0);" id="menuBtn" class="menuClose"></a>
            <nav id="button">
                <a href="javascript:;" class="searchBtn">搜索</a>
                <a href="javascript:;">登录</a>
                <a href="javascript:;">注册</a>
            </nav>
        </div>
        <form action="" class="search">
            <input type="text" placeholder="请输入搜索内容">
            <input type="submit" value="搜索">
        </form>
        <ul id="nav">
            <li><a href="javascript:void(0);">首页</a></li>
            <li><a href="javascript:void(0);">MV</a></li>
            <li><a href="javascript:void(0);">悦单</a></li>
            <li><a href="javascript:void(0);">V榜</a></li>
            <li><a href="javascript:void(0);">商城</a></li>
            <li><a href="javascript:void(0);">众筹</a></li>
            <li><a href="javascript:void(0);">节目</a></li>
            <li><a href="javascript:void(0);">我的应用</a></li>
            <li><a href="javascript:void(0);">我的家</a></li>
            <li><a href="javascript:void(0);">饭团</a></li>
            <li><a href="javascript:void(0);">咨询</a></li>
            <li><a href="javascript:void(0);">客服</a></li>
        </ul>
    </header>
    <div class="content">
        <nav id="navScroll">
            <ul id="navs">
                <li class="active"><a href="javascript:void(0);">首页</a></li>
                <li><a href="javascript:void(0);">MV</a></li>
                <li><a href="javascript:void(0);">悦单</a></li>
                <li><a href="javascript:void(0);">V榜</a></li>
                <li><a href="javascript:void(0);">商城</a></li>
                <li><a href="javascript:void(0);">众筹</a></li>
                <li><a href="javascript:void(0);">节目</a></li>
                <li><a href="javascript:void(0);">我的应用</a></li>
                <li><a href="javascript:void(0);">我的家</a></li>
                <li><a href="javascript:void(0);">饭团</a></li>
                <li><a href="javascript:void(0);">咨询</a></li>
                <li><a href="javascript:void(0);">客服</a></li>
            </ul>
        </nav>

        <!-- SLIDE START -->
        <div id="picTab">
            <ul id="picList">
                <li><a href="#"><img src="img/img3.jpg" alt=""></a></li>
                <li><a href="#"><img src="img/img1.jpg" alt=""></a></li>
                <li><a href="#"><img src="img/img2.jpg" alt=""></a></li>
                <li><a href="#"><img src="img/img3.jpg" alt=""></a></li>
                <li><a href="#"><img src="img/img1.jpg" alt=""></a></li>
            </ul>
            <div id="picNav">
                <span class="active"></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <!-- SLIDE END -->

        <!-- TAB START -->
        <section class="tab">
            <header class="tabHeader">
                <h2>MV首播</h2>
                <a href="#">更多</a>
            </header>
            <nav class="tabNav">
                <a href="javascript:void(0);">全部</a>
                <a href="javascript:void(0);">内地</a>
                <a href="javascript:void(0);">港台</a>
                <a href="javascript:void(0);">欧美</a>
                <a href="javascript:void(0);">韩国</a>
                <a href="javascript:void(0);">日本</a>
                <span></span>
            </nav>
            <section class="tabList">
                <ul class="tabNext">loading...</ul>
                <ul class="tabShow">
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                </ul>
                <ul class="tabNext">loading...</ul>
            </section>
        </section>
        <!-- TAB END -->

        <!-- TAB START -->
        <section class="tab">
            <header class="tabHeader">
                <h2>MV首播</h2>
                <a href="#">更多</a>
            </header>
            <nav class="tabNav">
                <a href="javascript:void(0);">全部</a>
                <a href="javascript:void(0);">内地</a>
                <a href="javascript:void(0);">港台</a>
                <a href="javascript:void(0);">欧美</a>
                <a href="javascript:void(0);">韩国</a>
                <a href="javascript:void(0);">日本</a>
                <span></span>
            </nav>
            <section class="tabList">
                <ul class="tabNext">loading...</ul>
                <ul class="tabShow">
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <img src="img/img.jpg" alt="pic">
                            <span>当我们混在一起 夏日版</span>
                        </a>
                    </li>
                </ul>
                <ul class="tabNext">loading...</ul>
            </section>
        </section>
        <!-- TAB END -->

    </div>
</section>
<script>
    /* button nav ****START****/
    navShow()
    function navShow() {
        var menuBtn = document.querySelector('#menuBtn')
        var nav = document.querySelector('#nav')

        menuBtn.addEventListener('touchstart', function (event) {
            if (this.className === 'menuClose') {
                this.className = 'menuShow'
                nav.style.display = 'block'
            } else {
                this.className = 'menuClose'
                nav.style.display = 'none'
            }

            event.stopPropagation()
        })

        nav.addEventListener('touchstart', function (event) {
            event.stopPropagation()
        })

        document.addEventListener('touchstart', function () {
            if (menuBtn.className === 'menuShow') {
                menuBtn.className = 'menuClose'
                nav.style.display = 'none'
            }
        })
    }
    /* button nav ****END****/

    /* slide ****START****/
    scrollPic()
    function scrollPic() {
        let wrapper = document.querySelector('#picTab')
        let list = document.querySelector('#picList')
        let li = list.querySelectorAll('li')
        let picNav = document.querySelector('#picNav')
        let span = picNav.querySelectorAll('span')
        // 记录触摸点开始结束的位置
        let startPoint = null
        //  let endPoint = null
        let horiStartPageX = 0
        // 记录list 初始的offsetLeft
        let start = 0
        // 手指滑动的方向
        let direction = ''
        let delay
        // 记录圆点索引
        let index = 0
        // 记录左侧隐藏区域的图片个数
        let hiddenPic = -1
        // 手指在水平方向上的移动距离
        let horiDistance = 0
        let isMove = false
        let isFirst = true

        // 设置容器的宽高
        wrapper.style.height = li[0].offsetHeight + 'px'
        list.style.width = li.length + '00%'

        for (let i = 0; i < li.length; i++) {
            li[i].style.width = (1 / li.length) * 100 + '%'
        }

        // 单个展示图片的宽度
        let uWidth = li[0].offsetWidth

        // 左右两侧增加图片，向左移动一格图片
        cssTransform(list, 'translateX', -uWidth)

        // 手指触碰到屏幕时
        wrapper.addEventListener('touchstart', function (ev) {
            startPoint = ev.changedTouches[0]

            // 无缝滑动
            if (hiddenPic === 1 - li.length) {
                list.style.WebkitTransition = list.style.transition = ''
                cssTransform(list, 'translateX', -1 * uWidth)
            }

            if (hiddenPic === 0) {
                list.style.WebkitTransition = list.style.transition = ''
                cssTransform(list, 'translateX', (2 - li.length) * uWidth)
            }

            horiStartPageX = startPoint.pageX
            start = cssTransform(list, 'translateX')
            isMove = true
            isFirst = true
        }, false)

        // 手指水平移动时
        wrapper.addEventListener('touchmove', function (ev) {
            if (!isMove) return

            let endPoint = ev.changedTouches[0]
            let horiEndPageX = 0
            let directionX = Math.abs(endPoint.pageX - startPoint.pageX)
            let directionY = Math.abs(endPoint.pageY - startPoint.pageY)

            list.style.WebkitTransition = list.style.transition = ''

            horiEndPageX = endPoint.pageX
            horiDistance = horiEndPageX - horiStartPageX
            // 判断手势是横向还是纵向
            if (isFirst) {
                isFirst = false
                if (directionX <= directionY) {
                    isMove = false
                }
            }

            if (isMove) {
                cssTransform(list, 'translateX', horiDistance + start)
            }
        })

        wrapper.addEventListener('touchend', function (ev) {
            // 手指离开屏幕时，list 的translateX
            let leaveTranslateX = cssTransform(list, 'translateX')

            for (let i = 0; i < span.length; i++) {
                span[i].className = ''
            }

            if (horiDistance < 0) {
                hiddenPic = Math.round(leaveTranslateX / uWidth - 0.3)
            } else {
                hiddenPic = Math.round(leaveTranslateX / uWidth + 0.3)
            }

            list.style.WebkitTransition = list.style.transition = 'transform 500ms linear'

            cssTransform(list, 'translateX', hiddenPic * uWidth)

        })
    }
    /* slide ****END****/

    /* swiping nav ****START****/
    navSwipe()
    function navSwipe() {

        var navScroll = document.querySelector('#navScroll')
        var navs = document.querySelector('#navs')
        var navsLi = navs.querySelectorAll('li')
        var navsOffsetWidth = 0
        // navs 的起始位移值
        var offsetX = 0
        // 手指触摸屏幕的起始水平坐标
        var touchStartX = 0
        // 手指在屏幕上滑动时的水平坐标
        var touchMoveX = 0
        // 惯性滑动
        var lastX = 0
        var lastTime = 0
        var XInterval = 0
        var timeInterval = 0

        navsLi.forEach(function (item) {
            navsOffsetWidth += item.offsetWidth
        })
        // navs向左滑动，当其右侧与navscroll右侧对齐时候，自身最小的translateX值
        var minTranslateX = navScroll.clientWidth - navsOffsetWidth

        // touchstart
        navs.addEventListener('touchstart', function (event) {
            var touch = event.changedTouches[0]

            navs.style.WebkitTransition = navs.style.transition = ''
            offsetX = cssTransform(navs, 'translateX')
            touchStartX = touch.pageX

            lastX = offsetX
            lastTime = new Date().getTime()
            XInterval = 0
            timeInterval = 0
        })

        // touchmove
        navs.addEventListener('touchmove', function (event) {
            var touch = event.changedTouches[0]
            var horiMoveDistance = 0
            var left = 0
            // 递减系数
            var decreaseRatio = 0
            // navs达到最小的translateX后，继续向左移动，超出部分的值
            var over = 0
            var nowTime = new Date().getTime()

            touchMoveX = touch.pageX
            horiMoveDistance = touchMoveX - touchStartX
            left = offsetX + horiMoveDistance

            if (left > 0) {
                // 50的存在是为了减少decreaseRatio
                decreaseRatio = 1 - (left + 50) / (navScroll.clientWidth + 50)
                left = parseInt(left * decreaseRatio)
            }
            if (left < minTranslateX) {
                over = minTranslateX - left
                decreaseRatio = 1 - (over + 50) / (navScroll.clientWidth + 50)
                over = parseInt(over * decreaseRatio)
                left = minTranslateX - over
            }

            // inertia slide
            XInterval = horiMoveDistance - lastX
            timeInterval = nowTime - lastTime
            console.log(timeInterval)
            lastX = horiMoveDistance
            lastTime = nowTime

            cssTransform(navs, 'translateX', left)
        })

        // touchend
        navs.addEventListener('touchend', function (event) {
            var slideDis = cssTransform(navs, 'translateX')
            var speed = 0
            var target = 0
            var type = 'cubic-bezier(.34, .92, .58, .9)'
            var time = 0

            if (timeInterval) {
                speed = XInterval / timeInterval
                target = slideDis + speed * 80
                time = Math.abs(speed * 120)
                time = time < 300 ? 300 : time

                if (target > 0) {
                    target = 0
                    type = 'cubic-bezier(.08, 1.44, .6, 1.46)'
                }
                if (target < minTranslateX) {
                    target = minTranslateX
                    type = 'cubic-bezier(.08, 1.44, .6, 1.46)'
                }

                navs.style.WebkitTransition = navs.style.transition = 'all ' + time + 'ms ' + type
                cssTransform(navs, 'translateX', target)
            }

        })
    }

    /* swiping nav ****END****/

    /* tab ****START****/
    tab()
    function tab() {
        let tabList = document.querySelectorAll('.tabList')
        let tabNav = document.querySelectorAll('.tabNav')
        let tabShow = document.querySelectorAll('.tabShow')
        let width = tabShow[0].offsetWidth

        for (let i = 0; i < tabNav.length; i++) {
            swipe(tabNav[i], tabList[i])
        }

        function swipe(nav, list) {
            cssTransform(list, 'translateX', -width)

            let startPoint = 0
            let startX = 0
            let now = 0

            // switch
            let isMove = true
            let isFirst = true
            let isLoad = false

            // get DOMNode
            let next = list.querySelectorAll('.tabNext')
            let navA = nav.querySelectorAll('a')
            let navActive = nav.querySelector('span')

            // touchstart event
            list.addEventListener('touchstart', function (e) {
                // ajax请求数据时，禁止滑动
                if (isLoad) return

                list.style.transition = ''
                startPoint = e.changedTouches[0]
                startX = cssTransform(list, 'translateX')

                // 防止上下滑动时的横向滑动
                isFirst = true
                isMove = true
            })

            // touchmove event
            list.addEventListener('touchmove', function (e) {
                if (isLoad) return
                if (!isMove) return

                let nowPoint = e.changedTouches[0]
                let disX = nowPoint.pageX - startPoint.pageX
                let disY = nowPoint.pageY - startPoint.pageY

                // isFirst 让判断滑动方向的语句只执行了一次，这是有必要的。因为当来回横向滑动时，disY 的绝对值是有可能大于 disX 的绝对值的
                if (isFirst) {
                    isFirst = false
                    if (Math.abs(disY) > Math.abs(disX)) {
                        isMove = false
                    }
                }

                if (isMove) {
                    cssTransform(list, 'translateX', startX + disX)
                }

                if (Math.abs(disX) > width / 2) {
                    end(disX)
                }
            })

            // touchend event
            list.addEventListener('touchend', function () {
                if (isLoad) return

                list.style.WebkitTransition = list.style.transition = '500ms'
                cssTransform(list, 'translateX', -width)
            })

            function end(disX) {
                isLoad = true

                let destination = disX > 0 ? 0 : -2 * width
                let direction = disX / Math.abs(disX)

                // tab 导航
                now += direction
                if (now < 0) {
                    now = navA.length - 1
                }
                if (now > navA.length -1) {
                    now = 0
                }

                list.style.transition = list.style.WebkitTransition = '500ms'
                cssTransform(list, 'translateX', destination)

                list.addEventListener('webkitTransitionEnd', transEnd)
                list.addEventListener('transitionend', transEnd)
            }
            
            function transEnd() {
                list.removeEventListener('webkitTransitionEnd', transEnd)
                list.removeEventListener('transitionend', transEnd)

                cssTransform(navActive, 'translateX', navA[now].offsetLeft)

                next.forEach(function (node) {
                    node.style.opacity = 1
                })

                // 模拟 ajax 向后台请求数据
                setTimeout(function () {
                    next.forEach(function (node) {
                        node.style.opacity = 0
                    })

                    list.style.WebkitTransition = list.style.transition = ''
                    cssTransform(list, 'translateX', -width)

                    isLoad = false
                }, 100)
            }
            
            
        }
    }


    /* tab ****END****/
</script>
</body>
</html>